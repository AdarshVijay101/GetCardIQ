generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password_hash     String
  two_factor_secret String?
  two_factor_enabled Boolean  @default(false)
  failed_login_attempts Int      @default(0)
  is_locked         Boolean  @default(false)
  lockout_until     DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  deleted_at        DateTime?

  sessions          Session[]
  cards             Card[]
  plaid_connections PlaidConnection[]
  transactions      Transaction[]
  notifications     Notification[]
  audit_logs        AuditLog[]
  jobs              JobRun[]

  // UX Overhaul Relations
  profile           UserProfile?
  credit_score      CreditScoreProfile?
  budget            Budget?
  goals             Goal[]
}

model Session {
  id             String   @id @default(uuid())
  user_id        String
  user           User     @relation(fields: [user_id], references: [id])
  token_hash     String
  device_name    String?
  ip_address     String?
  user_agent     String?
  expires_at     DateTime
  last_active_at DateTime @default(now())
  created_at     DateTime @default(now())
  @@index([user_id])
}

model Card {
  id                 String    @id @default(uuid())
  user_id            String
  user               User      @relation(fields: [user_id], references: [id])
  nickname           String
  card_type          String
  issuer             String
  annual_fee         Decimal   @default(0)
  color              String    @default("#1E3A8A")
  
  reward_currency        String    @default("points")
  current_points_balance Int       @default(0)
  point_value_cents      Decimal   @default(1.0)
  base_multiplier        Decimal   @default(1.0)
  bonus_rules            String?   // JSON
  
  plaid_account_id       String?
  mask                   String?
  current_balance        Decimal? @default(0)
  available_balance      Decimal? @default(0)
  credit_limit           Decimal? 

  benefits_fetched_at DateTime?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  deleted_at         DateTime?

  rewards            CardReward[]
  benefits           CardBenefit[]
  ledger             RewardLedger[]
  transactions       Transaction[] @relation("CardUsed")
  recommended_txs    Transaction[] @relation("RecommendedCard")
  rules              CardRewardRule[]
}

model RewardLedger {
  id                 String    @id @default(uuid())
  user_id            String
  card_id            String
  card               Card      @relation(fields: [card_id], references: [id])
  event_type         String 
  points_change      Int
  value_cents_change Int?
  transaction_id     String?
  note               String?
  created_at         DateTime  @default(now())
}

model CardReward {
  id            String   @id @default(uuid())
  card_id       String
  card          Card     @relation(fields: [card_id], references: [id])
  category      String
  reward_type   String
  reward_value  Decimal
  spending_cap  Decimal?
  created_at    DateTime @default(now())
}

model CardRewardRule {
  id           String   @id @default(uuid())
  card_id      String
  card         Card     @relation(fields: [card_id], references: [id])
  category     String 
  multiplier   Decimal
  spending_cap Decimal?
  created_at   DateTime @default(now())
}

model CardBenefit {
  id              String   @id @default(uuid())
  card_id         String
  card            Card     @relation(fields: [card_id], references: [id])
  benefit_type    String
  benefit_name    String
  benefit_value   Decimal?
  expiration_type String?
  expiration_date DateTime?
  created_at      DateTime @default(now())
}

model PlaidConnection {
  id                     String    @id @default(uuid())
  user_id                String
  user                   User      @relation(fields: [user_id], references: [id])
  access_token_encrypted Bytes
  institution_id         String
  institution_name       String?
  last_sync              DateTime?
  created_at             DateTime  @default(now())
}

model Transaction {
  id                    String    @id @default(uuid())
  user_id               String
  user                  User      @relation(fields: [user_id], references: [id])
  date                  DateTime
  merchant_name         String
  amount                Decimal
  category              String?
  plaid_transaction_id  String?   @unique
  
  card_used_id          String?
  card_used             Card?     @relation("CardUsed", fields: [card_used_id], references: [id])
  
  recommended_card_id   String?
  recommended_card      Card?     @relation("RecommendedCard", fields: [recommended_card_id], references: [id])
  
  potential_extra_value Decimal?
  ai_confidence         Decimal?
  ai_source             String?
  ai_error              String? 

  category_resolved       String?
  estimated_points_earned Int?
  estimated_value_cents   Int?
  best_possible_points    Int?
  missed_points           Int?
  
  description             String?
  
  created_at            DateTime  @default(now())
  deleted_at            DateTime?

  @@index([user_id, date])
}

model AIStatus {
  id              String   @id @default(uuid())
  mode            String
  is_reachable    Boolean
  last_check      DateTime @default(now())
  last_success_at DateTime?
  last_failure_at DateTime?
  last_error      String?
}

model MerchantCategory {
  id               String   @id @default(uuid())
  merchant_pattern String   @unique
  category         String
  confidence       Decimal  @default(0.95)
  times_seen       Int      @default(1)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
}

model Notification {
  id         String   @id @default(uuid())
  user_id    String
  user       User     @relation(fields: [user_id], references: [id])
  type       String
  priority   String
  title      String
  message    String
  action_url String?
  is_read    Boolean  @default(false)
  created_at DateTime @default(now())
}

model AuditLog {
  id            String   @id @default(uuid())
  event_type    String
  user_id       String?
  user          User?    @relation(fields: [user_id], references: [id])
  actor_id      String?
  resource_type String?
  resource_id   String?
  action        String?
  ip_address    String?
  user_agent    String?
  metadata      String?
  created_at    DateTime @default(now())

  @@index([user_id, created_at])
}

model JobRun {
  id        String    @id @default(uuid())
  user_id   String
  user      User      @relation(fields: [user_id], references: [id])
  job_name  String
  status    String    
  error     String?
  started_at DateTime @default(now())
  ended_at   DateTime?
}

model RefCard {
  id        String   @id @default(uuid())
  issuer    String
  name      String
  imageUrl  String?  @map("image_url")
  applyUrl  String?  @map("apply_url")
  annualFee String?  @map("annual_fee")
  apr       String?
  welcomeBonus String? @map("welcome_bonus")
  minSpend  String?  @map("min_spend")
  rewards   String   
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([issuer, name])
  @@map("ref_cards")
}

model UserProfile {
  id              String   @id @default(uuid())
  user_id         String   @unique
  user            User     @relation(fields: [user_id], references: [id])
  full_name       String?
  phone_number    String?
  zip_code        String?
  address_type    String? 
  marital_status  String? 
  children_count  Int      @default(0)
  has_vehicle     Boolean  @default(false)
  income_range    String?  
  updated_at      DateTime @updatedAt
}

model CreditScoreProfile {
  id            String   @id @default(uuid())
  user_id       String   @unique
  user          User     @relation(fields: [user_id], references: [id])
  score         Int      @default(0)
  source        String?
  last_updated  DateTime @default(now())
  history       String?
}

model Budget {
  id              String   @id @default(uuid())
  user_id         String   @unique
  user            User     @relation(fields: [user_id], references: [id])
  monthly_limit   Decimal  @default(0)
  alert_threshold Int      @default(80)
  categories      String?  
  updated_at      DateTime @updatedAt
}

model Goal {
  id                   String   @id @default(uuid())
  user_id              String
  user                 User     @relation(fields: [user_id], references: [id])
  name                 String
  reason               String   
  target_amount        Decimal
  current_amount       Decimal  @default(0)
  monthly_contribution Decimal  @default(0)
  target_date          DateTime
  funding_source_id    String?  
  status               String   @default("ACTIVE")
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  milestones           GoalMilestone[]
}

model GoalMilestone {
  id          String   @id @default(uuid())
  goal_id     String
  goal        Goal     @relation(fields: [goal_id], references: [id])
  percent     Int      
  reached_at  DateTime @default(now())
}
